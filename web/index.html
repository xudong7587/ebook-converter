<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TXT转EPUB工具</title>
    <style>
        :root {
            --primary-color: #4a6cf7;
            --secondary-color: #f0f2f5;
            --text-color: #333;
            --light-text: #666;
            --border-color: #eaeaea;
            --success-color: #52c41a;
            --error-color: #f56c6c;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), #6b8cff);
            color: white;
            padding: 20px 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .form-section {
            padding: 30px;
        }
        
        .section-title {
            font-size: 18px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            color: var(--primary-color);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 108, 247, 0.2);
        }
        
        .file-input {
            display: flex;
            align-items: center;
        }
        
        .file-input input[type="file"] {
            display: none;
        }
        
        .file-input label {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: var(--secondary-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 10px;
        }
        
        .file-input label:hover {
            background-color: #e9ecef;
        }
        
        .file-name {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: white;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .cover-preview {
            margin-top: 10px;
            max-width: 100%;
            max-height: 200px;
            border-radius: 4px;
            display: none;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
            text-align: center;
        }
        
        .btn:hover {
            background-color: #3a5cf0;
        }
        
        .btn-secondary {
            background-color: #f0f2f5;
            color: var(--text-color);
        }
        
        .btn-secondary:hover {
            background-color: #e9ecef;
        }
        
        .progress-container {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 4px;
            height: 8px;
            margin: 15px 0;
            overflow: hidden;
            display: none;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s;
        }
        
        .status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
            font-size: 14px;
        }
        
        .status-success {
            background-color: rgba(82, 196, 26, 0.1);
            color: var(--success-color);
            border-left: 3px solid var(--success-color);
        }
        
        .status-error {
            background-color: rgba(245, 108, 108, 0.1);
            color: var(--error-color);
            border-left: 3px solid var(--error-color);
        }
        
        .footer {
            background-color: var(--secondary-color);
            padding: 15px 30px;
            text-align: center;
            font-size: 14px;
            color: var(--light-text);
        }
        
        @media (max-width: 600px) {
            .form-section {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>TXT转EPUB工具</h1>
            <p>轻松将TXT文本转换为EPUB格式，并添加自定义封面</p>
        </div>
        
        <div class="form-section">
            <h2 class="section-title">基本信息</h2>
            <div class="form-group">
                <label for="title">书籍标题</label>
                <input type="text" id="title" class="form-control" placeholder="输入书籍标题" required>
            </div>
            <div class="form-group">
                <label for="author">作者</label>
                <input type="text" id="author" class="form-control" placeholder="输入作者名称" required>
            </div>
            
            <h2 class="section-title">文件上传</h2>
            <div class="form-group">
                <label for="txtFile">TXT文件</label>
                <div class="file-input">
                    <input type="file" id="txtFile" accept=".txt" required>
                    <label for="txtFile">选择TXT文件</label>
                    <div class="file-name" id="txtFileName">未选择文件</div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="coverFile">封面图片 (可选)</label>
                <div class="file-input">
                    <input type="file" id="coverFile" accept="image/*">
                    <label for="coverFile">选择封面图片</label>
                    <div class="file-name" id="coverFileName">未选择图片</div>
                </div>
                <img src="" alt="封面预览" class="cover-preview" id="coverPreview">
            </div>
            
            <h2 class="section-title">章节设置</h2>
            <div class="form-group">
                <label for="chapterPattern">章节识别模式</label>
                <select id="chapterPattern" class="form-control">
                    <option value="default">默认 (第X章,第X节)</option>
                    <option value="number">仅数字开头 (1.,2.,3.)</option>
                    <option value="roman">罗马数字 (第一章,第二章)</option>
                    <option value="custom">自定义正则表达式</option>
                </select>
            </div>
            
            <div class="form-group" id="customPatternGroup" style="display: none;">
                <label for="customPattern">自定义正则表达式</label>
                <input type="text" id="customPattern" class="form-control" placeholder="输入章节识别的正则表达式">
                <p class="text-muted mt-2">示例: ^第[一二三四五六七八九十百千0-9]+章</p>
            </div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <div class="status-message" id="statusMessage"></div>
            
            <button class="btn" id="convertBtn">开始转换</button>
        </div>
        
        <div class="footer">
            <p>© 2025 TXT转EPUB工具 | 简单易用的格式转换解决方案</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const txtFileInput = document.getElementById('txtFile');
            const coverFileInput = document.getElementById('coverFile');
            const txtFileName = document.getElementById('txtFileName');
            const coverFileName = document.getElementById('coverFileName');
            const coverPreview = document.getElementById('coverPreview');
            const titleInput = document.getElementById('title');
            const authorInput = document.getElementById('author');
            const convertBtn = document.getElementById('convertBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const statusMessage = document.getElementById('statusMessage');
            const chapterPattern = document.getElementById('chapterPattern');
            const customPatternGroup = document.getElementById('customPatternGroup');
            const customPattern = document.getElementById('customPattern');
            
            // 章节识别模式变化时的处理
            chapterPattern.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customPatternGroup.style.display = 'block';
                } else {
                    customPatternGroup.style.display = 'none';
                }
            });
            
            // 显示状态消息的函数
            function showStatus(message, type) {
                statusMessage.textContent = message;
                statusMessage.className = 'status-message';
                
                if (type === 'success') {
                    statusMessage.classList.add('status-success');
                } else if (type === 'error') {
                    statusMessage.classList.add('status-error');
                }
                
                statusMessage.style.display = 'block';
            }
            
            // 显示选择的TXT文件名
            txtFileInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    txtFileName.textContent = this.files[0].name;
                }
            });
            
            // 显示选择的封面图片和文件名
            coverFileInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    coverFileName.textContent = this.files[0].name;
                    
                    // 预览封面图片
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        coverPreview.src = e.target.result;
                        coverPreview.style.display = 'block';
                    }
                    reader.readAsDataURL(this.files[0]);
                }
            });
            
            // 生成UUID的函数
            function generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
            
            // 转换按钮点击事件
            convertBtn.addEventListener('click', function() {
                // 验证输入
                if (!titleInput.value || !authorInput.value || !txtFileInput.files[0]) {
                    showStatus('请填写所有必填信息并选择TXT文件', 'error');
                    return;
                }
                
                if (chapterPattern.value === 'custom' && !customPattern.value.trim()) {
                    showStatus('请输入自定义正则表达式', 'error');
                    return;
                }
                
                // 显示进度条
                progressContainer.style.display = 'block';
                statusMessage.style.display = 'none';
                
                // 读取TXT文件内容
                const txtFile = txtFileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const txtContent = e.target.result;
                    
                    // 创建EPUB文件
                    createEpub(txtContent).then(blob => {
                        // 保存EPUB文件
                        saveAs(blob, `${titleInput.value}.epub`);
                        
                        // 显示成功信息
                        showStatus(`EPUB文件创建成功: ${titleInput.value}.epub`, 'success');
                        
                        // 重置进度条
                        progressBar.style.width = '0%';
                    }).catch(error => {
                        console.error('转换失败:', error);
                        showStatus(`转换失败: ${error.message}`, 'error');
                        progressBar.style.width = '0%';
                    });
                };
                
                reader.onerror = function() {
                    showStatus('读取TXT文件失败', 'error');
                    progressBar.style.width = '0%';
                };
                
                reader.readAsText(txtFile);
            });
            
            // 创建EPUB文件的函数
            function createEpub(content) {
                return new Promise((resolve, reject) => {
                    try {
                        // 创建JSZip实例
                        const zip = new JSZip();
                        
                        // 设置进度
                        let progress = 0;
                        const totalSteps = 9; // 增加步骤数
                        
                        const updateProgress = (step) => {
                            progress = step;
                            progressBar.style.width = `${(progress / totalSteps) * 100}%`;
                        };
                        
                        // 添加必需的mimetype文件（未压缩）
                        zip.file('mimetype', 'application/epub+zip', {compression: 'STORE'});
                        updateProgress(1);
                        
                        // 创建META-INF目录和container.xml文件
                        const metaInf = zip.folder('META-INF');
                        metaInf.file('container.xml', `<?xml version="1.0" encoding="UTF-8"?>
                        <container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
                            <rootfiles>
                                <rootfile full-path="OPS/package.opf" media-type="application/oebps-package+xml"/>
                            </rootfiles>
                        </container>`, {compression: 'DEFLATE'});
                        updateProgress(2);
                        
                        // 创建META-INF/metadata.xml文件（EPUB 3标准要求）
                        metaInf.file('metadata.xml', `<?xml version="1.0" encoding="UTF-8"?>
                        <metadata xmlns="http://www.idpf.org/2007/opf">
                            <dc:title xmlns:dc="http://purl.org/dc/elements/1.1/">${escapeXml(titleInput.value)}</dc:title>
                            <dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">${escapeXml(authorInput.value)}</dc:creator>
                            <dc:language xmlns:dc="http://purl.org/dc/elements/1.1/">zh-CN</dc:language>
                            <dc:identifier xmlns:dc="http://purl.org/dc/elements/1.1/" id="bookid">urn:uuid:${generateUUID()}</dc:identifier>
                        </metadata>`, {compression: 'DEFLATE'});
                        updateProgress(3);
                        
                        // 创建OPS目录
                        const ops = zip.folder('OPS');
                        
                        // 创建content.opf文件（严格遵循EPUB 3标准）
                        const title = titleInput.value;
                        const author = authorInput.value;
                        const date = new Date().toISOString().split('T')[0];
                        const uuid = generateUUID();
                        
                        // 分析章节
                        const chapterPatternValue = chapterPattern.value;
                        let chapterRegex;
                        
                        switch (chapterPatternValue) {
                            case 'default':
                                chapterRegex = /^第[一二三四五六七八九十百千0-9]+[章节卷部篇集].*$/gm;
                                break;
                            case 'number':
                                chapterRegex = /^\d+\..*$/gm;
                                break;
                            case 'roman':
                                chapterRegex = /^第[一二三四五六七八九十百千]+章.*$/gm;
                                break;
                            case 'custom':
                                try {
                                    chapterRegex = new RegExp(customPattern.value, 'gm');
                                } catch (e) {
                                    throw new Error('无效的正则表达式: ' + e.message);
                                }
                                break;
                            default:
                                chapterRegex = /^第[一二三四五六七八九十百千0-9]+[章节卷部篇集].*$/gm;
                        }
                        
                        // 分割章节
                        updateProgress(4);
                        const chapters = splitIntoChapters(content, chapterRegex);
                        
                        if (chapters.length === 0) {
                            throw new Error('未识别到任何章节，请调整章节识别模式');
                        }
                        
                        // 生成章节文件
                        updateProgress(5);
                        const chapterFiles = generateChapterFiles(ops, chapters);
                        
                        // 生成manifest和spine条目
                        let manifestItems = '';
                        let spineItems = '';
                        let navMapItems = '';
                        
                        // 添加标题页和封面
                        manifestItems += `
                            <item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>
                            <item id="css" href="styles.css" media-type="text/css"/>
                            <item id="titlepage" href="titlepage.xhtml" media-type="application/xhtml+xml"/>
                        `;
                        
                        spineItems += `
                            <itemref idref="titlepage"/>
                        `;
                        
                        navMapItems += `
                            <navPoint id="navPoint-title" playOrder="1">
                                <navLabel>
                                    <text>标题页</text>
                                </navLabel>
                                <content src="titlepage.xhtml"/>
                            </navPoint>
                        `;
                        
                        // 添加章节
                        chapterFiles.forEach((chapter, index) => {
                            const id = `chapter${index + 1}`;
                            manifestItems += `<item id="${id}" href="${chapter.filename}" media-type="application/xhtml+xml"/>\n`;
                            spineItems += `<itemref idref="${id}"/>\n`;
                            
                            navMapItems += `
                                <navPoint id="navPoint-${id}" playOrder="${index + 2}">
                                    <navLabel>
                                        <text>${escapeXml(chapter.title)}</text>
                                    </navLabel>
                                    <content src="${chapter.filename}"/>
                                </navPoint>
                            `;
                        });
                        
                        // 添加封面（如果有）
                        if (coverFileInput.files && coverFileInput.files[0]) {
                            manifestItems += `
                                <item id="cover-image" href="cover.jpg" media-type="image/jpeg" properties="cover-image"/>
                                <item id="cover" href="cover.xhtml" media-type="application/xhtml+xml"/>
                            `;
                            
                            spineItems = `<itemref idref="cover" linear="no"/>\n` + spineItems;
                        }
                        
                        // 创建package.opf文件
                        ops.file('package.opf', `<?xml version="1.0" encoding="UTF-8"?>
                        <package version="3.0" xmlns="http://www.idpf.org/2007/opf" unique-identifier="bookid" prefix="rendition: http://www.idpf.org/vocab/rendition/#">
                            <metadata xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:opf="http://www.idpf.org/2007/opf">
                                <dc:title>${escapeXml(title)}</dc:title>
                                <dc:creator opf:role="aut">${escapeXml(author)}</dc:creator>
                                <dc:date opf:event="publication">${date}</dc:date>
                                <dc:identifier id="bookid" opf:scheme="UUID">urn:uuid:${uuid}</dc:identifier>
                                <dc:language>zh-CN</dc:language>
                                <meta name="cover" content="cover-image"/>
                                <meta property="dcterms:modified">${new Date().toISOString()}</meta>
                            </metadata>
                            <manifest>
                                ${manifestItems}
                            </manifest>
                            <spine toc="ncx">
                                ${spineItems}
                            </spine>
                        </package>`, {compression: 'DEFLATE'});
                        updateProgress(6);
                        
                        // 创建toc.ncx文件（改进版，支持EPUB 2导航）
                        ops.file('toc.ncx', `<?xml version="1.0" encoding="UTF-8"?>
                        <ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">
                            <head>
                                <meta name="dtb:uid" content="urn:uuid:${uuid}"/>
                                <meta name="dtb:depth" content="1"/>
                                <meta name="dtb:totalPageCount" content="0"/>
                                <meta name="dtb:maxPageNumber" content="0"/>
                            </head>
                            <docTitle>
                                <text>${escapeXml(title)}</text>
                            </docTitle>
                            <docAuthor>
                                <text>${escapeXml(author)}</text>
                            </docAuthor>
                            <navMap>
                                ${navMapItems}
                            </navMap>
                        </ncx>`, {compression: 'DEFLATE'});
                        updateProgress(7);
                        
                        // 创建CSS文件
                        ops.file('styles.css', `@namespace epub "http://www.idpf.org/2007/ops";

                        body {
                            font-family: "Helvetica Neue", Helvetica, "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
                            font-size: 1em;
                            line-height: 1.6;
                            color: #333;
                            margin: 1em;
                            text-align: justify;
                        }

                        h1, h2, h3 {
                            text-align: center;
                            margin-top: 2em;
                            margin-bottom: 1em;
                            page-break-after: avoid;
                        }

                        h1 {
                            font-size: 1.8em;
                        }

                        h2 {
                            font-size: 1.5em;
                        }

                        h3 {
                            font-size: 1.2em;
                        }

                        p {
                            text-indent: 2em;
                            margin-top: 0;
                            margin-bottom: 0.5em;
                        }

                        .no-indent {
                            text-indent: 0;
                        }

                        .cover {
                            text-align: center;
                            page-break-after: always;
                            height: 100%;
                        }

                        .cover img {
                            max-width: 100%;
                            max-height: 100%;
                            object-fit: contain;
                        }

                        .titlepage {
                            text-align: center;
                            height: 100%;
                            display: flex;
                            flex-direction: column;
                            justify-content: center;
                        }

                        .titlepage h1 {
                            font-size: 2.5em;
                            margin-bottom: 1em;
                        }

                        .titlepage h3 {
                            font-size: 1.5em;
                            margin-top: 0;
                        }

                        .chapter-title {
                            text-align: center;
                            font-size: 1.5em;
                            margin-top: 2em;
                            margin-bottom: 1em;
                            page-break-before: always;
                        }`, {compression: 'DEFLATE'});
                        
                        // 创建标题页
                        ops.file('titlepage.xhtml', `<?xml version="1.0" encoding="UTF-8"?>
                        <html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
                        <head>
                            <meta charset="UTF-8" />
                            <title>${escapeXml(title)}</title>
                            <link href="styles.css" rel="stylesheet" type="text/css" />
                        </head>
                        <body class="titlepage">
                            <h1>${escapeXml(title)}</h1>
                            <h3>作者: ${escapeXml(author)}</h3>
                            <p class="no-indent" style="margin-top: 2em;">${date}</p>
                        </body>
                        </html>`, {compression: 'DEFLATE'});
                        updateProgress(8);
                        
                        // 添加封面图片和封面页（如果有）
                        if (coverFileInput.files && coverFileInput.files[0]) {
                            const coverFile = coverFileInput.files[0];
                            const reader = new FileReader();
                            
                            reader.onload = function(e) {
                                const coverData = e.target.result;
                                // 从DataURL中提取二进制数据
                                const base64Data = coverData.split(',')[1];
                                const binaryData = Uint8Array.from(atob(base64Data), c => c.charCodeAt(0));
                                
                                // 添加封面图片
                                ops.file('cover.jpg', binaryData, {binary: true});
                                
                                // 添加封面HTML页
                                ops.file('cover.xhtml', `<?xml version="1.0" encoding="UTF-8"?>
                                <html xmlns="http://www.w3.org/1999/xhtml">
                                <head>
                                    <meta charset="UTF-8" />
                                    <title>封面</title>
                                    <link href="styles.css" rel="stylesheet" type="text/css" />
                                </head>
                                <body class="cover">
                                    <img src="cover.jpg" alt="${escapeXml(title)}封面" />
                                </body>
                                </html>`, {compression: 'DEFLATE'});
                                
                                // 生成EPUB文件
                                zip.generateAsync({type: 'blob'}, (metadata) => {
                                    updateProgress(8 + metadata.percent / 100);
                                }).then(blob => {
                                    updateProgress(totalSteps);
                                    resolve(blob);
                                }).catch(err => {
                                    reject(new Error('生成EPUB文件失败: ' + err.message));
                                });
                            };
                            
                            reader.onerror = function() {
                                reject(new Error('读取封面图片失败'));
                            };
                            
                            reader.readAsDataURL(coverFile);
                        } else {
                            // 没有封面图片，直接生成EPUB文件
                            zip.generateAsync({type: 'blob'}, (metadata) => {
                                updateProgress(8 + metadata.percent / 2);
                            }).then(blob => {
                                updateProgress(totalSteps);
                                resolve(blob);
                            }).catch(err => {
                                reject(new Error('生成EPUB文件失败: ' + err.message));
                            });
                        }
                    } catch (error) {
                        reject(new Error('创建EPUB文件时发生错误: ' + error.message));
                    }
                });
            }
            
            // 分割文本为章节
            function splitIntoChapters(content, regex) {
                const chapters = [];
                let currentChapter = { title: '前言', content: '' };
                chapters.push(currentChapter);
                
                // 使用正则表达式匹配章节标题
                const matches = [...content.matchAll(regex)];
                
                matches.forEach((match, index) => {
                    const title = match[0].trim();
                    const startIndex = match.index;
                    let endIndex = content.length;
                    
                    // 如果不是最后一个匹配，设置结束位置为下一个匹配的开始
                    if (index < matches.length - 1) {
                        endIndex = matches[index + 1].index;
                    }
                    
                    // 获取章节内容
                    const chapterContent = content.substring(startIndex, endIndex);
                    
                    // 创建新章节
                    currentChapter = { title, content: chapterContent };
                    chapters.push(currentChapter);
                });
                
                // 如果没有匹配到任何章节，将整个内容作为一个章节
                if (chapters.length === 1 && !chapters[0].content.trim()) {
                    chapters[0].title = '正文';
                    chapters[0].content = content;
                }
                
                return chapters;
            }
            
            // 生成章节文件
            function generateChapterFiles(opsFolder, chapters) {
                const chapterFiles = [];
                
                chapters.forEach((chapter, index) => {
                    // 生成文件名
                    const filename = `chapter${index + 1}.xhtml`;
                    
                    // 处理章节内容
                    const lines = chapter.content.split('\n');
                    const titleLine = lines.shift(); // 第一行是标题
                    
                    // 格式化剩余内容为段落
                    const formattedContent = lines
                        .filter(line => line.trim() !== '')
                        .map(line => `<p>${escapeXml(line)}</p>`)
                        .join('\n');
                    
                    // 创建章节XHTML文件
                    const xhtmlContent = `<?xml version="1.0" encoding="UTF-8"?>
                    <html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
                    <head>
                        <meta charset="UTF-8" />
                        <title>${escapeXml(chapter.title)}</title>
                        <link href="styles.css" rel="stylesheet" type="text/css" />
                    </head>
                    <body>
                        <h2 class="chapter-title">${escapeXml(chapter.title)}</h2>
                        <div class="chapter-content">
                            ${formattedContent}
                        </div>
                    </body>
                    </html>`;
                    
                    // 添加到OPS文件夹
                    opsFolder.file(filename, xhtmlContent, {compression: 'DEFLATE'});
                    
                    // 记录章节信息
                    chapterFiles.push({
                        title: chapter.title,
                        filename: filename
                    });
                });
                
                return chapterFiles;
            }
            
            // XML转义函数，确保特殊字符正确处理
            function escapeXml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
        });
    </script>
</body>
</html>
